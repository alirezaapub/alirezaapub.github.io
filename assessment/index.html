<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ابزار ارزیابی بالینی زبان کودک (فاز نهایی)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- افزودن کتابخانه‌های مورد نیاز -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg-page: #f4f7f9;
            --bg-card: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --border-color: #e2e8f0;
            --accent-color: #3b82f6;
            --accent-light: #dbeafe;
            --success-color: #10b981;
            --warning-color: #f97316;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-family: 'Vazirmatn', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-page);
            color: var(--text-primary);
            margin: 0;
            line-height: 1.6;
            scroll-behavior: smooth;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .main-header h1 { font-size: 2.2rem; font-weight: 700; text-align: center; }
        .main-header p { font-size: 1.1rem; color: var(--text-secondary); margin-top: 10px; text-align: center; }

        .card {
            background-color: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .card-header { padding: 20px 25px; border-bottom: 1px solid var(--border-color); }
        .card-header h2 { margin: 0; font-size: 1.5rem; }
        .card-body { padding: 25px; }

        .form-group { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); }
        .input-group input { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: var(--font-family); font-size: 1rem; }

        .assessment-section { border-top: 1px solid var(--border-color); padding-top: 25px; margin-top: 25px; }
        .assessment-section:first-child { border-top: none; padding-top: 0; margin-top: 0; }
        .assessment-section h3 { font-size: 1.3rem; margin-bottom: 20px; color: var(--accent-color); padding-bottom: 10px; border-bottom: 2px solid var(--accent-light); }
        
        .question-group { margin-bottom: 25px; }
        .question-group label { display: block; font-weight: 600; margin-bottom: 12px; }
        .question-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-card); font-family: var(--font-family); font-size: 1rem; cursor: pointer; }

        .main-button { background-color: var(--accent-color); color: white; border: none; padding: 15px 40px; font-size: 1.1rem; font-weight: 600; border-radius: 10px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        .main-button:hover { background-color: #2563eb; transform: translateY(-2px); }
        .center-container { text-align: center; padding: 20px 0; }

        #results-container { display: none; }
        .chart-container { padding: 15px; position: relative; margin: auto; min-height: 500px; width: 100%; }
        
        #recommendations-container { margin-top: 30px; }
        .recommendation-accordion .rec-item { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; }
        .rec-header { padding: 15px 20px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .rec-header .arrow { transition: transform 0.3s; }
        .rec-item.active .rec-header .arrow { transform: rotate(180deg); }
        .rec-body { max-height: 0; overflow: hidden; transition: max-height 0.5s ease, padding 0.5s ease; padding: 0 20px; }
        .rec-item.active .rec-body { max-height: 1000px; padding: 20px; border-top: 1px solid var(--border-color); }
        .rec-body h4 { color: var(--accent-color); }
        .rec-body ul { list-style-type: '✓ '; padding-right: 20px; }
        
        #download-btn { background-color: var(--success-color); }
        #download-btn:hover { background-color: #059669; }

        @media (max-width: 768px) {
            .form-group { grid-template-columns: 1fr; }
            .chart-container { min-height: 350px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="main-header">
            <h1>ابزار ارزیابی و طرح درمان زبان کودک</h1>
            <p>بر اساس مدل Paul (2017). اطلاعات را وارد کنید تا پروفایل زبان، تحلیل و طرح درمان پیشنهادی تولید شود.</p>
        </header>

        <main>
            <form id="assessment-form">
                <!-- Demographic and Assessment sections from previous phase -->
                <div class="card">
                    <div class="card-header"><h2>اطلاعات دموگرافیک</h2></div>
                    <div class="card-body">
                        <div class="form-group">
                            <div class="input-group"><label for="child-name">نام کودک</label><input type="text" id="child-name" name="child-name" placeholder="مثال: آریا" required></div>
                            <div class="input-group"><label for="chrono-age">سن تقویمی (به ماه)</label><input type="number" id="chrono-age" name="chrono-age" placeholder="مثال: 36" required></div>
                        </div>
                    </div>
                </div>
                <div id="assessment-container" class="card">
                     <div class="card-header"><h2>ارزیابی حوزه‌های زبان</h2></div>
                     <div class="card-body"></div>
                </div>
                <div class="center-container"><button type="submit" id="analyze-btn" class="main-button">تحلیل و ایجاد طرح درمان</button></div>
            </form>
            
            <div id="results-container">
                <div id="report-to-download" class="card">
                     <div class="card-header"><h2 id="results-title">پروفایل زبان</h2></div>
                     <div class="card-body">
                        <p class="text-secondary" style="text-align:center;">نمودار زیر، مقایسه بین سن تقویمی کودک (خط‌چین) و سطح عملکرد فعلی او (ناحیه آبی) در حوزه‌های مختلف زبان را نشان می‌دهد.</p>
                        <div class="chart-container"><canvas id="results-chart"></canvas></div>
                        <div id="recommendations-container">
                            <h3>اهداف درمانی و فعالیت‌های پیشنهادی</h3>
                            <p class="text-secondary">بر اساس تحلیل، حوزه‌های زیر به عنوان اولویت درمانی شناسایی شده‌اند. برای مشاهده اهداف و فعالیت‌ها روی هر مورد کلیک کنید.</p>
                            <div id="recommendation-accordion" class="recommendation-accordion"></div>
                        </div>
                     </div>
                </div>
                <div class="center-container"><button id="download-btn" class="main-button">دانلود گزارش (PDF)</button></div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Data and rendering logic from previous phases...
        const assessmentData = {
            semantics: {
                title: "معنی‌شناسی",
                receptive: [{ id: "sem-rec-1", question: "درک واژگان", options: [{ text: "انتخاب کنید...", value: 0 },{ text: "کمتر از ۵۰ کلمه (۱۸ ماهگی)", value: 18 },{ text: "۲۰۰-۳۰۰ کلمه (۲۴ ماهگی)", value: 24 },{ text: "حدود ۹۰۰ کلمه (۳۶ ماهگی)", value: 36 },{ text: "بیش از ۱۵۰۰ کلمه (۴۸ ماهگی)", value: 48 }] }],
                expressive: [{ id: "sem-exp-1", question: "گنجینه واژگان بیانی", options: [{ text: "انتخاب کنید...", value: 0 },{ text: "۱۰-۲۰ کلمه (۱۸ ماهگی)", value: 18 },{ text: "۵۰-۲۵۰ کلمه (۲۴ ماهگی)", value: 24 },{ text: "حدود ۱۰۰۰ کلمه (۳۶ ماهگی)", value: 36 },{ text: "بیش از ۲۰۰۰ کلمه (۴۸ ماهگی)", value: 48 }] }]
            },
            grammar: {
                title: "دستور زبان",
                receptive: [{ id: "gra-rec-1", question: "درک ساختار جمله", options: [{ text: "انتخاب کنید...", value: 0 },{ text: "جملات ساده (۲۴ ماهگی)", value: 24 },{ text: "ضمایر و جمع ساده (۳۶ ماهگی)", value: 36 },{ text: "جملات پیچیده (۴۸ ماهگی)", value: 48 }] }],
                expressive: [{ id: "gra-exp-1", question: "طول و پیچیدگی جمله", options: [{ text: "انتخاب کنید...", value: 0 },{ text: "تک/دو کلمه‌ای (۲۴ ماهگی)", value: 24 },{ text: "سه تا چهار کلمه‌ای (۳۶ ماهگی)", value: 36 },{ text: "جملات کامل (۴۸ ماهگی)", value: 48 }] }]
            },
            pragmatics: {
                title: "کاربردشناسی",
                receptive: [{ id: "pra-rec-1", question: "درک قوانین اجتماعی", options: [{ text: "انتخاب کنید...", value: 0 },{ text: "نوبت‌گیری ساده (۲۴ ماهگی)", value: 24 },{ text: "درک قصد و نیت (۵۴ ماهگی)", value: 54 }] }],
                expressive: [{ id: "pra-exp-1", question: "کارکردهای ارتباطی", options: [{ text: "انتخاب کنید...", value: 0 },{ text: "فقط درخواست و اعتراض (۲۴ ماهگی)", value: 24 },{ text: "اطلاع‌رسانی و پرسش (۳۶ ماهگی)", value: 36 },{ text: "روایت و توضیح (۴۸ ماهگی)", value: 48 }] }]
            }
        };

        const recommendationsData = {
            "semantics-receptive": {
                ltg: "بهبود درک واژگان و مفاهیم متناسب با سن",
                stgs: [
                    { level: 24, goal: "افزایش درک واژگان به حدود ۳۰۰ کلمه", activities: ["کتاب‌خوانی تعاملی روزانه و اشاره به تصاویر و نام بردن آن‌ها.", "بازی 'این چیه؟' با اشیاء واقعی در محیط خانه.", "دسته‌بندی اسباب‌بازی‌ها بر اساس نوع (حیوانات، وسایل نقلیه)."] },
                    { level: 36, goal: "افزایش درک مفاهیم پایه (فضایی، کیفی)", activities: ["بازی با لگو و استفاده از دستورات حاوی مفاهیم: 'لگوی قرمز رو بذار روی برج'.", "پیدا کردن اشیاء 'بزرگ' و 'کوچک' در محیط.", "دنبال کردن دستورات دو مرحله‌ای: 'توپ رو بردار و بنداز تو سبد'."] }
                ]
            },
            "semantics-expressive": {
                ltg: "افزایش گنجینه واژگان بیانی و استفاده از آن برای بیان نیازها",
                stgs: [
                    { level: 24, goal: "افزایش واژگان بیانی به بالای ۵۰ کلمه", activities: ["گسترش گفته‌های کودک: او می‌گوید 'ماشین'، شما بگویید 'بله، یک ماشین آبی سریع'.", "ایجاد موقعیت‌های انتخابی برای تشویق به کلام: 'شیر می‌خوای یا آب؟'.", "آواز خواندن و تکرار کلمات کلیدی در شعر."] },
                    { level: 36, goal: "استفاده از کلمات برای توصیف و پرسش", activities: ["بازی 'من چی می‌بینم؟' برای توصیف اشیاء.", "تشویق به پرسیدن سوال 'این چیه؟' و دادن پاسخ‌های ساده.", "تعریف کردن کارهای روزمره حین انجام آن‌ها."] }
                ]
            },
            "grammar-expressive": {
                ltg: "افزایش طول و پیچیدگی دستوری جملات",
                stgs: [
                    { level: 24, goal: "ترکیب دو کلمه برای ساخت جملات ساده", activities: ["مدل‌سازی جملات دو کلمه‌ای حین بازی: 'بابا رفت'، 'نی‌نی خوابید'، 'توپ بده'.", "استفاده از کتاب‌های تصویری با جملات ساده و تکرار آن‌ها.", "ترغیب کودک به ترکیب فاعل و فعل برای توصیف تصاویر."] },
                    { level: 36, goal: "استفاده از جملات ۳-۴ کلمه‌ای و نشانه‌های صرفی اولیه", activities: ["بازی با عروسک‌ها و مدل‌سازی جملات حاوی ضمیر و فعل: 'من می‌خورم'، 'تو می‌خوابی'.", "صحبت در مورد تصاویر با استفاده از جملات کامل.", "استفاده از نشانه‌های جمع در بازی: 'ببین، دو تا ماشین'."] }
                ]
            }
            // More recommendations can be added for other domains...
        };

        const form = document.getElementById('assessment-form');
        const resultsContainer = document.getElementById('results-container');
        const resultsTitle = document.getElementById('results-title');
        const downloadBtn = document.getElementById('download-btn');
        let resultsChart = null;

        function renderAssessment() {
            const container = document.querySelector('#assessment-container .card-body');
            let html = '';
            for (const domainKey in assessmentData) {
                const domain = assessmentData[domainKey];
                html += `<div class="assessment-section"><h3>${domain.title}</h3>`;
                domain.receptive.forEach(q => { html += `<div class="question-group"><label for="${q.id}"><strong>درکی:</strong> ${q.question}</label><select id="${q.id}" name="${q.id}" required>${q.options.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}</select></div>`; });
                domain.expressive.forEach(q => { html += `<div class="question-group"><label for="${q.id}"><strong>بیانی:</strong> ${q.question}</label><select id="${q.id}" name="${q.id}" required>${q.options.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}</select></div>`; });
                html += `</div>`;
            }
            container.innerHTML = html;
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            const formData = new FormData(form);
            const childName = formData.get('child-name');
            const chronoAge = parseInt(formData.get('chrono-age'), 10);
            if (isNaN(chronoAge) || chronoAge <= 0) { alert('لطفاً سن تقویمی معتبر وارد کنید.'); return; }

            const scores = {};
            for (const domainKey in assessmentData) {
                scores[domainKey] = { receptive: 0, expressive: 0 };
                let recCount = 0, expCount = 0, recSum = 0, expSum = 0;
                assessmentData[domainKey].receptive.forEach(q => { const val = parseInt(formData.get(q.id), 10); if (val > 0) { recSum += val; recCount++; } });
                assessmentData[domainKey].expressive.forEach(q => { const val = parseInt(formData.get(q.id), 10); if (val > 0) { expSum += val; expCount++; } });
                scores[domainKey].receptive = recCount > 0 ? Math.round(recSum / recCount) : 0;
                scores[domainKey].expressive = expCount > 0 ? Math.round(expSum / expCount) : 0;
            }
            
            resultsTitle.textContent = `پروفایل زبان برای: ${childName}`;
            renderResultsChart({ chronoAge, scores });
            generateRecommendations({ chronoAge, scores });
            resultsContainer.style.display = 'block';
            window.location.hash = "results-container";
        }

        function renderResultsChart(results) {
            const ctx = document.getElementById('results-chart').getContext('2d');
            const labels = [];
            const languageAgeData = [];
            for (const domainKey in results.scores) {
                const domain = results.scores[domainKey];
                const domainTitle = assessmentData[domainKey].title;
                labels.push(`درک ${domainTitle}`);
                languageAgeData.push(domain.receptive);
                labels.push(`بیان ${domainTitle}`);
                languageAgeData.push(domain.expressive);
            }
            const chronoAgeData = Array(labels.length).fill(results.chronoAge);
            if (resultsChart) { resultsChart.destroy(); }
            resultsChart = new Chart(ctx, { /* Chart.js config from previous phase */ 
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'سن تقویمی', data: chronoAgeData, borderColor: 'rgba(107, 114, 128, 0.5)', borderWidth: 2, borderDash: [5, 5], fill: false }, { label: 'سن زبانی', data: languageAgeData, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 2, fill: true }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { font: { family: 'Vazirmatn', size: 14 } } }, tooltip: { bodyFont: { family: 'Vazirmatn' }, titleFont: { family: 'Vazirmatn' } } }, scales: { r: { pointLabels: { font: { family: 'Vazirmatn', size: 13, weight: '600' } }, ticks: { backdropColor: 'rgba(255, 255, 255, 0.75)', stepSize: 6 } } } }
            });
        }

        function generateRecommendations(results) {
            const container = document.getElementById('recommendation-accordion');
            container.innerHTML = '';
            let hasRecommendations = false;

            for (const domainKey in results.scores) {
                ['receptive', 'expressive'].forEach(type => {
                    const languageAge = results.scores[domainKey][type];
                    const chronoAge = results.chronoAge;
                    const gap = chronoAge - languageAge;
                    const fullDomainKey = `${domainKey}-${type}`;

                    // Identify priority areas (e.g., gap > 6 months)
                    if (gap > 6 && recommendationsData[fullDomainKey]) {
                        hasRecommendations = true;
                        const recData = recommendationsData[fullDomainKey];
                        // Find the next appropriate goal based on current language age
                        const targetStg = recData.stgs.find(stg => languageAge < stg.level);
                        
                        if (targetStg) {
                            const recItem = document.createElement('div');
                            recItem.className = 'rec-item';
                            recItem.innerHTML = `
                                <div class="rec-header" style="background-color: var(--accent-light);">
                                    <span><strong>اولویت:</strong> ${assessmentData[domainKey].title} (${type === 'receptive' ? 'درکی' : 'بیانی'})</span>
                                    <span class="arrow">▼</span>
                                </div>
                                <div class="rec-body">
                                    <h4>هدف بلندمدت (LTG):</h4>
                                    <p>${recData.ltg}</p>
                                    <h4>هدف کوتاه‌مدت پیشنهادی (STG):</h4>
                                    <p>${targetStg.goal}</p>
                                    <h4>فعالیت‌های پیشنهادی:</h4>
                                    <ul>${targetStg.activities.map(act => `<li>${act}</li>`).join('')}</ul>
                                </div>
                            `;
                            container.appendChild(recItem);
                        }
                    }
                });
            }
            if (!hasRecommendations) {
                container.innerHTML = '<p style="text-align:center;">بر اساس داده‌های وارد شده، تاخیر قابل توجهی که نیاز به اولویت‌بندی درمانی داشته باشد، مشاهده نشد. عملکرد کودک در محدوده‌ی سنی خود قرار دارد.</p>';
            }
            
            // Add accordion functionality
            container.querySelectorAll('.rec-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.parentElement.classList.toggle('active');
                });
            });
        }

        async function downloadReport() {
            const reportElement = document.getElementById('report-to-download');
            const { jsPDF } = window.jspdf;
            
            // Temporarily add a white background to ensure non-transparent capture
            reportElement.style.backgroundColor = 'white';

            const canvas = await html2canvas(reportElement, {
                scale: 2, // Higher scale for better quality
                useCORS: true,
                logging: false,
                onclone: (document) => {
                    // This is crucial for fonts to render in the captured image
                    const head = document.head;
                    const style = document.createElement('style');
                    style.innerHTML = `
                        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
                        body { font-family: 'Vazirmatn', sans-serif !important; }
                    `;
                    head.appendChild(style);
                }
            });
            
            // Revert background color after capture
            reportElement.style.backgroundColor = '';

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = imgWidth / imgHeight;
            const newImgWidth = pdfWidth - 20; // with margin
            const newImgHeight = newImgWidth / ratio;
            
            let heightLeft = newImgHeight;
            let position = 10; // top margin
            
            pdf.addImage(imgData, 'PNG', 10, position, newImgWidth, newImgHeight);
            heightLeft -= (pdfHeight - 20);

            while (heightLeft > 0) {
                position = heightLeft - newImgHeight + 10; // top margin for new page
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 10, position, newImgWidth, newImgHeight);
                heightLeft -= (pdfHeight - 20);
            }
            
            const childName = document.getElementById('child-name').value || 'report';
            pdf.save(`${childName.replace(/\s/g, '_')}_language_profile.pdf`);
        }

        // Initial Render & Event Listeners
        renderAssessment();
        form.addEventListener('submit', handleFormSubmit);
        downloadBtn.addEventListener('click', downloadReport);
    });
    </script>

</body>
</html>

